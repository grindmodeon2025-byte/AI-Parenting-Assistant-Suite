<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emotion Check-in & Support — Export / Print</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:20px; background:#fff; color:#111827; }
    .entry-card { background:#fffaf6; border-left:6px solid #ff8a80; padding:14px; border-radius:10px; margin-bottom:14px; box-shadow:0 6px 18px rgba(15,23,42,0.03); }
    .meta { color:#6b7280; font-size:0.92rem; }
    .highlight { background:#eef9ff; border-radius:8px; padding:10px; margin-top:10px; border:1px solid rgba(3,105,161,0.06); }
    .tiny { font-size:0.85rem; color:#6b7280; }
    .no-print { }
    @media print { .no-print { display:none !important; } .entry-card { page-break-inside: avoid; } }
  </style>
</head>
<body>
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 class="mb-0">Emotion Check-in & Support</h4>
      <div class="tiny">Examples: Mood = "anxious"; Trigger = "missed nap"; Intensity = "moderate".</div>
    </div>
    <div class="no-print d-flex gap-2">
      <a href="/" class="btn btn-outline-secondary btn-sm">← Home</a>
      <button id="printBtn" class="btn btn-success btn-sm">Print / Save as PDF</button>
      <button id="exportPdfBtn" class="btn btn-primary btn-sm">Export as PDF</button>
    </div>
  </div>

  <!-- Form -->
  <div class="card mb-4 p-3">
    <form id="emotionForm" class="row g-2">
      <div class="col-md-3">
        <input id="user_type" class="form-control" placeholder="Who (Parent)" value="Parent" required>
      </div>
      <div class="col-md-3">
        <input id="mood" class="form-control" placeholder="Mood (e.g., anxious, frustrated)" required>
      </div>
      <div class="col-md-2">
        <input id="intensity" class="form-control" placeholder="Intensity (mild/moderate/strong, on scale of 1 to 10)">
      </div>
      <div class="col-md-4">
        <input id="trigger" class="form-control" placeholder="Trigger / Context (e.g., missed nap)">
      </div>

      <div class="col-12">
        <input id="behaviors" class="form-control" placeholder="Behaviors / Observations (e.g., crying)">
      </div>
      <div class="col-12">
        <input id="notes" class="form-control" placeholder="Notes / Caregiver Response (e.g., offered a hug)">
      </div>

      <div class="col-12 text-end mt-2 no-print">
        <button type="reset" class="btn btn-light btn-sm">Reset</button>
        <button id="submitBtn" class="btn btn-primary btn-sm" type="submit">Log Emotion</button>
      </div>
    </form>
  </div>

  <!-- Entries -->
  <div id="entriesContainer"></div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const { jsPDF } = window.jspdf;

    const form = document.getElementById('emotionForm');
    const entriesContainer = document.getElementById('entriesContainer');
    const printBtn = document.getElementById('printBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');

    let entries = [];

    function nowStamp(){ return new Date().toLocaleString(); }
    function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    // render UI
    function render() {
      entriesContainer.innerHTML = '';
      if(entries.length === 0){
        entriesContainer.innerHTML = '<div class="text-muted">No entries yet. Fill the form and log an emotion.</div>';
        return;
      }

      entries.forEach((e, idx) => {
        const card = document.createElement('div');
        card.className = 'entry-card';
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div style="display:flex; gap:8px; align-items:center;">
                <h6 style="margin:0; text-transform:capitalize;">${escapeHtml(e.mood)}</h6>
                <div class="tiny">${escapeHtml(e.user_type)} • ${escapeHtml(e.intensity || '')}</div>
              </div>
              <div class="meta mt-1">${escapeHtml(e.trigger || '')}${e.duration ? ' • ' + escapeHtml(e.duration) : ''}</div>
            </div>
            <div class="text-end tiny">
              ${escapeHtml(e.timestamp)}
              <div style="margin-top:6px"><small>Entry #${idx+1}</small></div>
            </div>
          </div>

          <div class="mt-3"><strong>Behaviors / Observations</strong><div class="tiny">${escapeHtml(e.behaviors || 'N/A')}</div></div>
          <div class="mt-2"><strong>Notes / Caregiver Response</strong><div class="tiny">${escapeHtml(e.notes || 'N/A')}</div></div>

          <div class="mt-3 d-flex gap-2 justify-content-end no-print">
            <button class="btn btn-outline-primary btn-sm btn-support">Get Supportive Message</button>
            <button class="btn btn-outline-secondary btn-sm btn-copy">Copy</button>
            <button class="btn btn-outline-danger btn-sm btn-delete">Delete</button>
          </div>
        `;

        // support block
        if(e.support){
          const support = document.createElement('div');
          support.className = 'highlight';
          support.innerHTML = `
            <div><strong>Supportive response</strong></div>
            <div style="margin-top:8px">${escapeHtml(e.support.message || '')}</div>
            <div style="margin-top:8px"><strong>Suggestion:</strong> ${escapeHtml(e.support.suggestion || '')}</div>
            <div style="margin-top:8px"><strong>Affirmation:</strong> <em>${escapeHtml(e.support.affirmation || '')}</em></div>
            ${e.support._rawModelOutput ? `<div style="margin-top:8px" class="tiny text-muted">Raw model output present (for debugging)</div>` : ''}
          `;
          card.appendChild(support);
        }

        // copy
        card.querySelector('.btn-copy').addEventListener('click', () => {
          const text = formatEntryForCopy(e);
          navigator.clipboard?.writeText(text).then(()=> {
            const btn = event.target;
            btn.innerText = 'Copied';
            setTimeout(()=> btn.innerText = 'Copy', 1200);
          }).catch(()=> alert('Copy failed — try selecting text manually.'));
        });

        // delete
        card.querySelector('.btn-delete').addEventListener('click', () => {
          if(!confirm('Delete this entry?')) return;
          entries = entries.filter(it => it.id !== e.id);
          render();
        });

        // support
        card.querySelector('.btn-support').addEventListener('click', async (ev) => {
          const btn = ev.target;
          btn.disabled = true; btn.innerText = 'Generating...';
          try {
            const res = await fetch('/api/generate-support', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ entry: e })
            });
            if(!res.ok){
              const text = await res.text();
              console.error('Server error:', res.status, text);
              alert('Server failed to generate a supportive message. See console.');
            } else {
              const json = await res.json();
              // attach result to entry
              const idxEntry = entries.findIndex(it => it.id === e.id);
              if(idxEntry >= 0){
                // normalize keys if backend returned _rawModelOutput fallback
                entries[idxEntry].support = {
                  message: json.message || json.msg || '',
                  suggestion: json.suggestion || json.advice || '',
                  affirmation: json.affirmation || json.aff || '',
                  _rawModelOutput: json._rawModelOutput || json._raw || ''
                };
              }
              render();
            }
          } catch (err) {
            console.error('Fetch error', err);
            alert('Failed to contact server. Check console and server logs.');
          } finally {
            btn.disabled = false; btn.innerText = 'Get Supportive Message';
          }
        });

        entriesContainer.appendChild(card);
      });
    }

    // build plain text for copy
    function formatEntryForCopy(e){
      const lines = [
        `Emotion Check-in (${e.timestamp})`,
        `Who: ${e.user_type}`,
        `Mood: ${e.mood} (${e.intensity || '—'})`,
        `Trigger: ${e.trigger || '—'}`,
        `Behaviors: ${e.behaviors || '—'}`,
        `Notes: ${e.notes || '—'}`,
        ''
      ];
      if(e.support){
        lines.push('Supportive response:', e.support.message || '');
        lines.push('Suggestion: ' + (e.support.suggestion || ''));
        lines.push('Affirmation: ' + (e.support.affirmation || ''));
      }
      return lines.join('\n');
    }

    // form submission -> store entry locally
    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      const e = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
        user_type: document.getElementById('user_type').value.trim(),
        mood: document.getElementById('mood').value.trim(),
        intensity: document.getElementById('intensity')?.value?.trim() || '',
        trigger: document.getElementById('trigger')?.value?.trim() || '',
        behaviors: document.getElementById('behaviors')?.value?.trim() || '',
        notes: document.getElementById('notes')?.value?.trim() || '',
        timestamp: nowStamp(),
        support: null
      };
      if(!e.mood){
        alert('Please enter a mood (e.g., anxious).');
        return;
      }
      entries.unshift(e); // newest first
      // clear form except user_type
      document.getElementById('mood').value = '';
      document.getElementById('intensity').value = '';
      document.getElementById('trigger').value = '';
      document.getElementById('behaviors').value = '';
      document.getElementById('notes').value = '';
      render();
    });

    // Print (browser dialog)
    printBtn.addEventListener('click', () => window.print());

    // Export as PDF using jsPDF — includes support block if present
    exportPdfBtn.addEventListener('click', () => {
      if(entries.length === 0){ alert('No entries to export.'); return; }
      const sorted = [...entries]; // keep order as displayed (newest first)
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const pw = 210, ph = 297, margin = 12;
      let y = 12;

      doc.setFontSize(14); doc.setFont('helvetica','bold');
      doc.text('Emotion Check-ins — AI Parenting Assistant', margin, y);
      y += 6;
      doc.setFontSize(9); doc.setFont('helvetica','normal');
      doc.text('Exported: ' + new Date().toLocaleString(), margin, y);
      y += 8;

      const lh = 6;
      sorted.forEach((e, i) => {
        const title = `${i+1}. ${e.mood || ''} (${e.user_type || ''} • ${e.intensity || '—'})`;
        const meta = `${e.trigger || '—'} • ${e.timestamp || ''}`;
        const behaviorsLines = doc.splitTextToSize(e.behaviors || 'N/A', pw - margin*2 - 10);
        const notesLines = doc.splitTextToSize(e.notes || 'N/A', pw - margin*2 - 10);

        // support lines
        const supportPresent = !!e.support;
        const supportMsgLines = supportPresent ? doc.splitTextToSize(e.support.message || '', pw - margin*2 - 10) : [];
        const supportSugLines = supportPresent ? doc.splitTextToSize(e.support.suggestion || '', pw - margin*2 - 10) : [];
        const supportAffLines = supportPresent ? doc.splitTextToSize(e.support.affirmation || '', pw - margin*2 - 10) : [];

        const headerH = (doc.splitTextToSize(title, pw - margin*2 - 8).length + doc.splitTextToSize(meta, pw - margin*2 - 8).length) * lh + 6;
        const behaviorsH = behaviorsLines.length * lh + 6;
        const notesH = notesLines.length * lh + 6;
        const supportH = (supportMsgLines.length + supportSugLines.length + supportAffLines.length) * lh + (supportPresent ? 18 : 0);
        const totalH = headerH + behaviorsH + notesH + supportH + 12;

        if(y + totalH > ph - margin){
          doc.addPage();
          y = margin;
        }

        // pale box
        doc.setFillColor(255,245,240);
        doc.roundedRect(margin, y, pw - margin*2, totalH - 6, 3, 3, 'F');

        let cursor = y + 6;
        doc.setFont('helvetica','bold'); doc.setFontSize(11);
        doc.text(doc.splitTextToSize(title, pw - margin*2 - 8), margin + 4, cursor);
        cursor += doc.splitTextToSize(title, pw - margin*2 - 8).length * lh;

        doc.setFont('helvetica','normal'); doc.setFontSize(9);
        doc.text(doc.splitTextToSize(meta, pw - margin*2 - 8), margin + 4, cursor + 2);
        cursor += doc.splitTextToSize(meta, pw - margin*2 - 8).length * lh + 6;

        doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text('Behaviors / Observations', margin + 4, cursor);
        cursor += lh - 2;
        doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(behaviorsLines, margin + 6, cursor);
        cursor += behaviorsLines.length * lh + 6;

        doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text('Notes / Caregiver Response', margin + 4, cursor);
        cursor += lh - 2;
        doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(notesLines, margin + 6, cursor);
        cursor += notesLines.length * lh + 8;

        if(supportPresent){
          doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text('Supportive Response', margin + 4, cursor);
          cursor += lh - 2;
          doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(supportMsgLines, margin + 6, cursor);
          cursor += supportMsgLines.length * lh + 6;

          doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text('Suggestion', margin + 4, cursor);
          cursor += lh - 2;
          doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(supportSugLines, margin + 6, cursor);
          cursor += supportSugLines.length * lh + 6;

          doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.text('Affirmation', margin + 4, cursor);
          cursor += lh - 2;
          doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(supportAffLines, margin + 6, cursor);
          cursor += supportAffLines.length * lh + 6;
        }

        y += totalH;
      });

      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const fname = `emotion-checkins-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;
      doc.save(fname);
    });

    // initial render
    render();

    // expose entries for quick debugging
    window._entries = entries;
  });
  </script>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
